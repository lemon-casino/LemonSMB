<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SMB Browser</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; display: flex; }
        #menu { width: 220px; height: 100vh; overflow-y: auto; border-right: 1px solid #ccc; padding: 10px; box-sizing: border-box; background: #f7f7f7; }
        #files { flex: 1; height: 100vh; overflow-y: auto; padding: 10px; box-sizing: border-box; display: flex; flex-wrap: wrap; gap: 10px; align-content: flex-start; }
        ul { list-style: none; padding-left: 20px; }
        li { cursor: pointer; padding: 4px 0; }
        li:hover { background: #eee; }
        .thumb { width: 200px; height: 150px; object-fit: cover; border-radius: 4px; box-shadow: 0 1px 4px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
<div id="menu"></div>
<div id="files">
    <div id="fileList"></div>
</div>
<script>
    let currentPath = '';
    let offset = 0;
    const limit = 20;
    let loading = false;
    let hasMore = true;

    function buildMenu(parent, nodes, path) {
        const ul = document.createElement('ul');
        nodes.forEach(n => {
            const li = document.createElement('li');
            li.textContent = n.name;
            li.onclick = () => {
                currentPath = path + '/' + n.name;
                offset = 0;
                document.getElementById('fileList').innerHTML = '';
                loadFiles();
                if (n.children && n.children.length > 0 && !li.querySelector('ul')) {
                    buildMenu(li, n.children, currentPath);
                }
            };
            ul.appendChild(li);
        });
        parent.appendChild(ul);
    }

    function loadFiles() {
        if (loading || !hasMore) return;
        loading = true;
        fetch(`/files?path=${encodeURIComponent(currentPath)}&offset=${offset}&limit=${limit}`)
            .then(r => r.json())
            .then(list => {
                const container = document.getElementById('fileList');
                list.forEach(f => {
                    const img = document.createElement('img');
                    img.className = 'thumb';
                    img.src = `/image?id=${encodeURIComponent(f)}&thumbnail=true`;
                    container.appendChild(img);
                });
                if (list.length < limit) {
                    hasMore = false;
                }
                offset += list.length;
            })
            .finally(() => loading = false);
    }


    document.getElementById('files').addEventListener('scroll', () => {
        const c = document.getElementById('files');
        if (c.scrollTop + c.clientHeight >= c.scrollHeight - 50) {
            loadFiles();
        }
    });

    fetch('/metadata')
        .then(r => r.json())
        .then(data => {
            if (data && data.folders) {
                buildMenu(document.getElementById('menu'), data.folders, '视觉素材库');
            }
        });
</script>
</body>
</html>
